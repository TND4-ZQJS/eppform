<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Zero Interest EPP — Web Filler (Merged UI)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{--bg:#f6f7f9;--card:#fff;--accent:#007aff;--muted:#666;}
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;margin:18px;background:var(--bg);color:#111}
  main{max-width:980px;margin:0 auto;background:var(--card);padding:18px;border-radius:10px;box-shadow:0 8px 28px rgba(0,0,0,0.06)}
  h1{margin-top:0;font-size:1.25rem}
  .section{background:#fbfbfd;border:1px solid #eee;padding:12px;border-radius:8px;margin:12px 0}
  .section h2{margin:0 0 8px 0}
  label{display:block;margin:8px 0;font-size:0.95rem}
  input[type=text],input[type=email],input[type=number],input[type=tel],select,textarea{
    width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-top:6px;font-size:1rem;
  }
  textarea{resize:none;overflow:hidden}
  .inline{display:inline-flex;align-items:center;margin-right:12px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .header-row{align-items:center}
  .amount{display:flex;flex-direction:column;min-width:160px}
  .card-number-block .card-number-inputs{display:flex;gap:8px;margin-top:8px}
  .card-digit{width:80px;padding:8px;border-radius:8px;border:1px solid #ddd;text-align:center;font-size:1.05rem}
  .card-digit:focus{outline:2px solid rgba(0,122,255,0.15)}
  .small label{flex:1}
  .muted{color:var(--muted);font-size:0.85rem}
  button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
  button.secondary{background:#999}
  .actions{display:flex;gap:12px;align-items:center}
  footer{margin-top:12px;color:var(--muted)}
  .policy-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .policy{background:#fff;padding:10px;border-radius:8px;border:1px solid #eee}
  .policy h3{margin:0 0 8px 0;font-size:0.95rem}
  .tiny{font-size:0.85rem;color:var(--muted)}
  @media (max-width:720px){
    .policy-grid{grid-template-columns:1fr}
    .card-digit{width:60px}
    .row{flex-direction:column;align-items:stretch}
  }

  /* --- Signature preview (from amendment filler) --- */
  .sig-preview{
    border:1px solid #ccc;border-radius:8px;width:100%;height:120px;background:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;
  }
  .sig-preview img{max-width:100%; max-height:100%}
  /* Modal */
  #sigModal{ display:none; position:fixed; z-index:9999; left:0;top:0; width:100%;height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; }
  #sigModalContent{ background:#fff; padding:12px; border-radius:8px; display:flex; flex-direction:column; align-items:center; gap:10px; max-width:96%; width:720px; }
  #sigCanvas{ border:1px solid #ccc; border-radius:8px; touch-action:none; display:block; }

  /* Save indicator */
  #saveStatus{ position:fixed; bottom:12px; right:12px; background:var(--accent); color:#fff; padding:6px 10px; border-radius:6px; font-size:0.85rem; opacity:0; transition:opacity .25s; }

  /* Uppercase visual style for Section 1 & 5 */
  .section1 input, .section5 input { text-transform: uppercase; }
</style>
</head>
<body>
<main>
  <h1>Zero Interest EPP — Web Filler (Merged UI)</h1>

  <section class="section section1" id="section1">
    <h2>Section 1 — Cardholder Details</h2>
    <label>Cardholder Name
      <input id="Cardholder_Name" type="text" placeholder="As printed">
    </label>
    <label>Mailing Address Line 1
      <input id="Cardholder_MailingAdd_Line1" type="text">
    </label>
    <label>Mailing Address Line 2
      <input id="Cardholder_MailingAdd_Line2" type="text">
    </label>
    <div class="row">
      <label style="flex:1">IC No. / NIRC
        <input id="Cardholder_NIRC" type="text" placeholder="e.g. 940101-01-1234">
      </label>
      <label style="flex:1">Home No.
        <input id="Cardholder_HomeNo" type="text" placeholder="Home number">
      </label>
      <label style="flex:1">Mobile No.
        <input id="Cardholder_MobileNo" type="text" placeholder="Mobile number">
      </label>
    </div>
  </section>

  <section class="section" id="section2">
    <h2>Section 2 — Bank & Card Type</h2>

    <div class="row">
      <label style="flex:1">Credit Card Number (UI uses 4×4 boxes)
        <div class="card-number-block">
          <div class="card-number-inputs">
            <input class="card-digit" id="CC_1" maxlength="4" inputmode="numeric" pattern="\d*">
            <input class="card-digit" id="CC_2" maxlength="4" inputmode="numeric" pattern="\d*">
            <input class="card-digit" id="CC_3" maxlength="4" inputmode="numeric" pattern="\d*">
            <input class="card-digit" id="CC_4" maxlength="4" inputmode="numeric" pattern="\d*">
          </div>
          <small class="muted tiny">Type 4 digits per box. Paste full 16-digit number — it will auto-split.</small>
        </div>
      </label>

      <label style="min-width:140px">Expiry Month
        <select id="CC_MM_Select">
          <option value="">-- Month --</option>
          <option value="01">01 - JAN</option>
          <option value="02">02 - FEB</option>
          <option value="03">03 - MAR</option>
          <option value="04">04 - APR</option>
          <option value="05">05 - MAY</option>
          <option value="06">06 - JUN</option>
          <option value="07">07 - JUL</option>
          <option value="08">08 - AUG</option>
          <option value="09">09 - SEP</option>
          <option value="10">10 - OCT</option>
          <option value="11">11 - NOV</option>
          <option value="12">12 - DEC</option>
        </select>
      </label>
      <label style="min-width:140px">Expiry Year
        <select id="CC_YY_Select">
          <option value="">-- Year --</option>
        </select>
      </label>
    </div>

    <div class="row">
      <label style="flex:1">
        Card Bank
        <select id="CC_Bank_Select">
          <option value="">-- choose bank --</option>
          <option value="CC_Bank_UOB">UOB</option>
          <option value="CC_Bank_CIMB">CIMB</option>
          <option value="CC_Bank_HLB">Hong Leong Bank (HLB)</option>
          <option value="CC_Bank_PBB">Public Bank (PBB)</option>
          <option value="CC_Bank_MBB">Maybank (MBB)</option>
          <option value="CC_Bank_HSBC">HSBC</option>
          <option value="CC_Bank_Alliance">Alliance Bank</option>
          <option value="CC_Bank_StanChart">Standard Chartered</option>
        </select>
      </label>

      <label style="width:200px">
        Card Type
        <select id="CardType_Select">
          <option value="">-- choose card type --</option>
          <option value="Visa">Visa</option>
          <option value="Master">Master</option>
        </select>
      </label>

      <label style="width:220px">
        EPP Term
        <select id="EPPTerm_Select">
          <option value="">-- choose term --</option>
          <option value="EPPTerm_6Months">6 months</option>
          <option value="EPPTerm_12Months">12 months</option>
        </select>
      </label>
    </div>

  </section>

  <section class="section" id="section3">
    <h2>Section 3 — Frequency After EPP</h2>
    <label>
      Frequency after EPP ended
      <select id="AfterEPP_Select">
        <option value="">-- choose frequency --</option>
        <option value="AfterEPP_Annually">Annually</option>
        <option value="AfterEPP_Halfyearly">Half-yearly</option>
        <option value="AfterEPP_Quarterly">Quarterly</option>
        <option value="AfterEPP_Monthly">Monthly</option>
      </select>
    </label>
  </section>

  <section class="section" id="section4">
    <h2>Section 4 — Policy Details (up to 5)</h2>
    <div id="policiesContainer" class="policy-grid"></div>
    <div class="row">
      <button id="addPolicy">+ Add Policy</button>
      <small class="muted tiny">Up to 5 policies</small>
    </div>
  </section>

  <section class="section section5" id="section5">
    <h2>Section 5 — Signatures & Witness</h2>

    <div class="row">
         <label style="flex:1">Signed State
      <select id="Signed_State" name="Signed_State" required>
        <option value="" disabled selected>-- Select State --</option>
        <option value="SELANGOR">SELANGOR</option>
        <option value="K.LUMPUR">K.LUMPUR</option>
        <option value="MELAKA">MELAKA</option>
        <option value="N.SEMBILAN">N.SEMBILAN</option>
        <option value="JOHOR">JOHOR</option>
        <option value="PENANG">PENANG</option>
        <option value="PERAK">PERAK</option>
        <option value="KEDAH">KEDAH</option>
        <option value="PAHANG">PAHANG</option>
        <option value="PERLIS">PERLIS</option>
        <option value="SARAWAK">SARAWAK</option>
        <option value="SABAH">SABAH</option>
        <option value="TERENGGANU">T'GANU</option>
        <option value="KELANTAN">KELANTAN</option>
      </select>
    </label>
      <label>Day
        <select id="Signed_Day"><option value="">Day</option></select>
      </label>
      <label>Month
        <select id="Signed_Month"><option value="">Month</option></select>
      </label>
      <label>Year
        <select id="Signed_Year"><option value="">Year</option></select>
      </label>
    </div>

    <h3>Cardholder Signature</h3>
    <div class="sig-preview" id="preview_cardholder" onclick="openSig('cardholder')">
      <span>Tap to Sign (Cardholder)</span>
    </div>
    <div class="row">
      <button id="clearPreviewCardholder" class="secondary">Clear Signature</button>
    </div>

    <div class="row small">
      <label>Witness Name
        <input id="Witness_Name" type="text">
      </label>
      <label>Witness NRIC
        <input id="Witness_NRIC" type="text">
      </label>
    </div>

    <h3 style="margin-top:12px">Witness Signature</h3>
    <div class="sig-preview" id="preview_witness" onclick="openSig('witness')">
      <span>Tap to Sign (Witness)</span>
    </div>
    <div class="row">
      <button id="clearPreviewWitness" class="secondary">Clear Signature</button>
    </div>
  </section>

  <div class="sig-controls">
  <h3>Signature Placement</h3>

  <div class="sig-control">
    <label>Cardholder X: <input type="number" id="cardholder_x" value="360"></label>
    <label>Y: <input type="number" id="cardholder_y" value="120"></label>
    <label>Scale: <input type="number" id="cardholder_scale" value="0.45" step="0.05"></label>
  </div>

  <div class="sig-control">
    <label>Witness X: <input type="number" id="witness_x" value="140"></label>
    <label>Y: <input type="number" id="witness_y" value="120"></label>
    <label>Scale: <input type="number" id="witness_scale" value="0.45" step="0.05"></label>
  </div>

  <button id="saveCoords">Save Settings</button>
</div>

  <section class="section actions">
    <button id="generate">Generate PDF</button>
    <button id="resetAll" class="secondary">Reset All</button>
  </section>

  <footer>
    <small>Make sure <code>Zero Interest Easy Payment Plan Form_LF1739_fillable.pdf</code> is in the same folder as this HTML.</small>
  </footer>
</main>

<div id="sigModal">
  <div id="sigModalContent">
    <canvas id="sigCanvas"></canvas>
    <div style="display:flex;gap:8px;">
      <button id="saveSigBtn">Done</button>
      <button id="clearSigBtn" class="secondary">Clear</button>
      <button id="cancelSigBtn" class="secondary">Cancel</button>
    </div>
  </div>
</div>

<div id="saveStatus">Saved</div>

<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<script>
/* ---------- CONFIG ---------- */
const PDF_FILENAME = "Zero Interest Easy Payment Plan Form_LF1739_fillable.pdf";
const MAX_POLICIES = 5;

/* ---------- helpers ---------- */
function $(id){return document.getElementById(id);}
function safeSetText(form, name, text){
  try{ form.getTextField(name).setText(String(text || "")); } catch(e){}
}
function safeCheck(form, name, checked){
  try{ const cb = form.getCheckBox(name); if (checked) cb.check(); else cb.uncheck(); } catch(e){}
}

/* ---------- Policies dynamic (updated) ---------- */
const policiesContainer = $("policiesContainer");
const addPolicyBtn = $("addPolicy");
let policyCount = 0;

function setupPolicyOwnerCheckbox(ownerInput, cardholderNameInput, checkbox) {
  checkbox.addEventListener('change', () => {
    if (checkbox.checked) {
      ownerInput.value = cardholderNameInput.value.toUpperCase();
    } else {
      ownerInput.value = '';
    }
    // save the value after change
    localStorage.setItem(ownerInput.id, ownerInput.value);
    localStorage.setItem(checkbox.id, checkbox.checked);
    showSaveStatus();
  });

  // Also listen for changes on the cardholder name and update if checked
  cardholderNameInput.addEventListener('input', () => {
    if (checkbox.checked) {
      ownerInput.value = cardholderNameInput.value.toUpperCase();
      localStorage.setItem(ownerInput.id, ownerInput.value);
      showSaveStatus();
    }
  });

  // Restore the checkbox state on load
  const savedCheckboxState = localStorage.getItem(checkbox.id);
  if (savedCheckboxState === 'true') {
    checkbox.checked = true;
    ownerInput.value = cardholderNameInput.value.toUpperCase();
  }
}

function createPolicyEntry(index){
  const wrap = document.createElement("div");
  wrap.className = "policy";
  wrap.dataset.index = index;
  const title = document.createElement("h3"); title.textContent = `Policy ${index}`; wrap.appendChild(title);

  const pNoLabel = document.createElement("label"); pNoLabel.textContent = "Policy No.";
  const pNoInput = document.createElement("input"); pNoInput.type="text"; pNoInput.id=`Paymentfor_PolicyNo${index}`; pNoInput.placeholder=`Paymentfor_PolicyNo${index}`;
  pNoLabel.appendChild(pNoInput); wrap.appendChild(pNoLabel);
  
  // New checkbox
  const sameOwnerRow = document.createElement("div"); sameOwnerRow.className = "row";
  const sameOwnerLabel = document.createElement("label"); sameOwnerLabel.className = "inline";
  const sameOwnerCheckbox = document.createElement("input");
  sameOwnerCheckbox.type = "checkbox";
  sameOwnerCheckbox.id = `sameAsCardholder_${index}`;
  sameOwnerLabel.appendChild(sameOwnerCheckbox);
  sameOwnerLabel.appendChild(document.createTextNode(" Same as Cardholder"));
  sameOwnerRow.appendChild(sameOwnerLabel);
  wrap.appendChild(sameOwnerRow);

  const ownerLabel = document.createElement("label"); ownerLabel.textContent = "Owner Name";
  const ownerInput = document.createElement("input"); ownerInput.type="text"; ownerInput.id=`Paymentfor_PolicyNo${index}_OwnerName`; ownerInput.placeholder=`Paymentfor_PolicyNo${index}_OwnerName`;
  ownerLabel.appendChild(ownerInput); wrap.appendChild(ownerLabel);

  const relLabel = document.createElement("label"); relLabel.textContent = "Relationship";
  const relSelect = document.createElement("select"); relSelect.id=`Paymentfor_PolicyNo${index}_Relationship`;
  ["","Ownself","Spouse","Children","Parents","Grandparents","Siblings","Employer/Employee"].forEach(opt=>{
    const o=document.createElement("option"); o.value=opt; o.textContent=opt===""?"-- choose --":opt; relSelect.appendChild(o);
  });
  relLabel.appendChild(relSelect); wrap.appendChild(relLabel);

  const premLabel = document.createElement("label"); premLabel.textContent = "First Premium (RM)";
  const premInput = document.createElement("input"); premInput.type="text"; premInput.id=`Paymentfor_PolicyNo${index}_FirstPremium`; premInput.placeholder="e.g. 1200.00";
  premLabel.appendChild(premInput); wrap.appendChild(premLabel);

  if(index>1){
    const rem=document.createElement("button"); rem.type="button"; rem.className="secondary"; rem.textContent="Remove"; rem.style.marginTop="8px";
    rem.addEventListener("click", ()=>{
      localStorage.removeItem(`sameAsCardholder_${index}`);
      localStorage.removeItem(`Paymentfor_PolicyNo${index}`);
      localStorage.removeItem(`Paymentfor_PolicyNo${index}_OwnerName`);
      localStorage.removeItem(`Paymentfor_PolicyNo${index}_Relationship`);
      localStorage.removeItem(`Paymentfor_PolicyNo${index}_FirstPremium`);
      wrap.remove(); policyCount--; addPolicyBtn.disabled=false; reorganizePolicyIndices();
      showSaveStatus();
    });
    wrap.appendChild(rem);
  }

  // Set up the capitalization and checkbox logic
  const cardholderNameInput = $("Cardholder_Name");
  setupPolicyOwnerCheckbox(ownerInput, cardholderNameInput, sameOwnerCheckbox);
  ownerInput.addEventListener("input", (e) => {
    e.target.value = e.target.value.toUpperCase();
    debounceSave(() => saveElValue(e.target), 120)();
  });

  return wrap;
}
function addPolicy(){ if(policyCount>=MAX_POLICIES) return; policyCount++; policiesContainer.appendChild(createPolicyEntry(policyCount)); if(policyCount>=MAX_POLICIES) addPolicyBtn.disabled=true; }
function reorganizePolicyIndices(){
  const nodes = Array.from(policiesContainer.querySelectorAll(".policy"));
  policyCount = nodes.length;
  nodes.forEach((n, idx)=> {
    const oldIdx = n.dataset.index;
    const newIdx = idx+1;
    n.dataset.index=newIdx; n.querySelector("h3").textContent=`Policy ${newIdx}`;
    
    // Update all IDs and re-wire listeners
    const pNo = n.querySelector(`#Paymentfor_PolicyNo${oldIdx}`); if(pNo){ pNo.id=`Paymentfor_PolicyNo${newIdx}`; pNo.placeholder=`Paymentfor_PolicyNo${newIdx}`;}
    const owner = n.querySelector(`#Paymentfor_PolicyNo${oldIdx}_OwnerName`); if(owner){ owner.id=`Paymentfor_PolicyNo${newIdx}_OwnerName`; owner.placeholder=`Paymentfor_PolicyNo${newIdx}_OwnerName`;}
    const rel = n.querySelector(`#Paymentfor_PolicyNo${oldIdx}_Relationship`); if(rel){ rel.id=`Paymentfor_PolicyNo${newIdx}_Relationship`;}
    const prem = n.querySelector(`#Paymentfor_PolicyNo${oldIdx}_FirstPremium`); if(prem){ prem.id=`Paymentfor_PolicyNo${newIdx}_FirstPremium`; prem.placeholder=`Paymentfor_PolicyNo${newIdx}_FirstPremium`;}
    const checkbox = n.querySelector(`#sameAsCardholder_${oldIdx}`);
    if(checkbox) {
        checkbox.id = `sameAsCardholder_${newIdx}`;
        setupPolicyOwnerCheckbox(owner, $("Cardholder_Name"), checkbox);
    }
  });
  addPolicyBtn.disabled = policyCount >= MAX_POLICIES;
}
addPolicyBtn.addEventListener("click", addPolicy);
addPolicy(); // start with 1

/* ---------- Credit card number inputs (unchanged) ---------- */
const ccDigits = [ $("CC_1"), $("CC_2"), $("CC_3"), $("CC_4") ];
ccDigits.forEach((el, idx)=>{
  el.addEventListener("input", ()=>{ el.value = el.value.replace(/\D/g,'').slice(0,4); if(el.value.length===4 && idx<ccDigits.length-1) ccDigits[idx+1].focus(); });
  el.addEventListener("keydown", (e)=>{ if(e.key==="Backspace" && el.value.length===0 && idx>0) ccDigits[idx-1].focus(); });
  el.addEventListener("paste", (e)=>{
    e.preventDefault();
    const paste = (e.clipboardData || window.clipboardData).getData('text');
    const digits = paste.replace(/\D/g,'').slice(0,16).padEnd(16,' ');
    for(let i=0;i<4;i++){ ccDigits[i].value = digits.slice(i*4, i*4+4).trim(); }
    for(let i=0;i<4;i++){ if(ccDigits[i].value.length<4){ ccDigits[i].focus(); break; } if(i===3) ccDigits[3].focus(); }
  });
});

/* ---------- NEW: Card expiry year dropdown population ---------- */
(function populateCCYearSelector() {
  const yearSel = document.getElementById("CC_YY_Select");
  const currentYear = new Date().getFullYear();
  for (let y = currentYear; y <= currentYear + 10; y++) {
    const option = document.createElement("option");
    option.value = String(y).slice(-2);
    option.textContent = y;
    yearSel.appendChild(option);
  }
})();

/* ---------- Signature modal (shared) ---------- */
const sigModal = $("sigModal"), sigCanvas = $("sigCanvas"), sigModalContent = $("sigModalContent");
const saveSigBtn = $("saveSigBtn"), clearSigBtn = $("clearSigBtn"), cancelSigBtn = $("cancelSigBtn");
const previews = { cardholder: $("preview_cardholder"), witness: $("preview_witness") };
let activeSigField = null;
let sigCtx = sigCanvas.getContext('2d');
let drawing = false;

function resizeSigCanvas(){
  const dpr = window.devicePixelRatio || 1;
  const cssWidth = Math.min(window.innerWidth * 0.95, 700);
  const cssHeight = cssWidth / 3.3;
  sigCanvas.width = cssWidth * dpr;
  sigCanvas.height = cssHeight * dpr;
  sigCanvas.style.width = cssWidth + 'px';
  sigCanvas.style.height = cssHeight + 'px';
  sigCtx.setTransform(dpr,0,0,dpr,0,0);
  sigCtx.lineWidth = 2.5;
  sigCtx.lineCap = 'round';
  sigCtx.strokeStyle = '#000';
}
function openSig(field){
  activeSigField = field;
  sigModal.style.display = 'flex';
  resizeSigCanvas();
  sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
  const saved = localStorage.getItem(field + '_sig');
  if(saved){
    const img = new Image();
    img.src = saved;
    img.onload = ()=> sigCtx.drawImage(img,0,0,sigCanvas.width/(window.devicePixelRatio||1), sigCanvas.height/(window.devicePixelRatio||1));
  }
}
function closeSig(){ sigModal.style.display = 'none'; activeSigField = null; }

sigCanvas.addEventListener('mousedown', e=>{ drawing=true; sigCtx.beginPath(); sigCtx.moveTo(e.offsetX,e.offsetY); });
sigCanvas.addEventListener('mousemove', e=>{ if(!drawing) return; sigCtx.lineTo(e.offsetX,e.offsetY); sigCtx.stroke(); });
sigCanvas.addEventListener('mouseup', ()=>drawing=false);
sigCanvas.addEventListener('mouseleave', ()=>drawing=false);
sigCanvas.addEventListener('touchstart', e=>{ e.preventDefault(); const t=e.touches[0]; const rect=sigCanvas.getBoundingClientRect(); sigCtx.beginPath(); sigCtx.moveTo(t.clientX-rect.left, t.clientY-rect.top); drawing=true; }, {passive:false});
sigCanvas.addEventListener('touchmove', e=>{ e.preventDefault(); if(!drawing) return; const t=e.touches[0]; const rect=sigCanvas.getBoundingClientRect(); sigCtx.lineTo(t.clientX-rect.left, t.clientY-rect.top); sigCtx.stroke(); }, {passive:false});
sigCanvas.addEventListener('touchend', ()=>drawing=false);

saveSigBtn.addEventListener('click', ()=>{
  if(!activeSigField) return;
  const dataURL = sigCanvas.toDataURL();
  localStorage.setItem(activeSigField + '_sig', dataURL);
  previews[activeSigField].innerHTML = `<img src="${dataURL}">`;
  closeSig();
  showSaveStatus();
});
clearSigBtn.addEventListener('click', ()=>{
  sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
  localStorage.removeItem(activeSigField + '_sig');
  previews[activeSigField].innerHTML = `<span>Tap to Sign (${activeSigField==='witness'?'Witness':'Cardholder'})</span>`;
});
cancelSigBtn.addEventListener('click', closeSig);

/* Clear preview buttons */
$("clearPreviewCardholder").addEventListener("click", ()=>{
  localStorage.removeItem('cardholder_sig');
  previews.cardholder.innerHTML = `<span>Tap to Sign (Cardholder)</span>`;
});
$("clearPreviewWitness").addEventListener("click", ()=>{
  localStorage.removeItem('witness_sig');
  previews.witness.innerHTML = `<span>Tap to Sign (Witness)</span>`;
});

/* On load - restore previews if saved */
function restoreSignaturePreviews(){
  const c = localStorage.getItem('cardholder_sig');
  const w = localStorage.getItem('witness_sig');
  if(c) previews.cardholder.innerHTML = `<img src="${c}">`;
  if(w) previews.witness.innerHTML = `<img src="${w}">`;
}
restoreSignaturePreviews();

/* ---------- Signed date selects (same as amendment filler) ---------- */
(function populateDateSelectors(){
  const daySel = $("Signed_Day");
  for(let i=1;i<=31;i++) daySel.innerHTML += `<option>${i}</option>`;
  const monthSel = $("Signed_Month");
  const months = ["JANUARY","FEBRUARY","MARCH","APRIL","MAY","JUNE","JULY","AUGUST","SEPTEMBER","OCTOBER","NOVEMBER","DECEMBER"];
  months.forEach(m=> monthSel.innerHTML += `<option>${m}</option>`);
  const yearSel = $("Signed_Year");
  const current = new Date().getFullYear();
  for(let y=current;y>=current-5;y--) yearSel.innerHTML += `<option>${y}</option>`;
})();

/* ---------- localStorage autosave + restore (updated) ---------- */
const saveStatusEl = $("saveStatus");
let saveTimer = null;
function showSaveStatus(){
  saveStatusEl.style.opacity = 1;
  clearTimeout(saveStatusEl._timer);
  saveStatusEl._timer = setTimeout(()=> saveStatusEl.style.opacity = 0, 1200);
}

/* Debounced save wrapper */
function debounceSave(fn, wait=150){
  let t;
  return function(...args){ clearTimeout(t); t = setTimeout(()=> fn.apply(this,args), wait); };
}

/* Save an element's value to localStorage (for inputs & selects) */
function saveElValue(el){
  if(!el || !el.id) return;
  if(el.type === 'checkbox'){
      localStorage.setItem(el.id, el.checked);
  } else {
      localStorage.setItem(el.id, el.value);
  }
  showSaveStatus();
}

/* Initialize inputs/selects/textarea: restore and attach listeners */
document.querySelectorAll("input,select,textarea").forEach(el=>{
  // restore
  const saved = localStorage.getItem(el.id);
  if(saved !== null) {
    if (el.type === 'checkbox') {
        el.checked = (saved === 'true');
    } else {
        el.value = saved;
    }
  }

  // attach listener
  el.addEventListener("input", ()=>{
    // uppercase enforcement for section1, section5, and policy owner name inputs
    if( el.closest(".section1") || el.closest(".section5") || (el.closest(".policy") && el.id.includes("_OwnerName")) ){
      if(el.type !== "number" && el.inputMode !== "numeric" && el.tagName.toLowerCase() !== 'select'){
        el.value = el.value.toUpperCase();
      }
    }
    // save debounced
    debounceSave(()=> saveElValue(el), 120)();
  });

  if (el.type === 'checkbox') {
    el.addEventListener('change', () => {
      localStorage.setItem(el.id, el.checked);
      showSaveStatus();
    });
  }
});

/* ---------- Fill PDF ---------- */
function canvasIsBlank(ctx, canvas){
  try {
    const w = Math.min(10, canvas.width);
    const data = ctx.getImageData(0,0,w,1).data;
    for (let i=0;i<data.length;i+=4){
      if (!(data[i]===255 && data[i+1]===255 && data[i+2]===255)) return false;
    }
  } catch(e){ return false; }
  return true;
}

async function fillPDF(){
  try {
    $("generate").disabled = true;

    const res = await fetch(PDF_FILENAME);
    if (!res.ok) throw new Error("Cannot load PDF: " + PDF_FILENAME);
    const bytes = await res.arrayBuffer();
    const pdfDoc = await PDFLib.PDFDocument.load(bytes);
    const form = pdfDoc.getForm();

    // Section 1
    safeSetText(form, "Cardholder_Name", $("Cardholder_Name").value || "");
    safeSetText(form, "Cardholder_MailingAdd_Line1", $("Cardholder_MailingAdd_Line1").value || "");
    safeSetText(form, "Cardholder_MailingAdd_Line2", $("Cardholder_MailingAdd_Line2").value || "");
    safeSetText(form, "Cardholder_NIRC", $("Cardholder_NIRC").value || "");
    safeSetText(form, "Cardholder_HomeNo", $("Cardholder_HomeNo").value || "");
    safeSetText(form, "Cardholder_MobileNo", $("Cardholder_MobileNo").value || "");

    // CC combined
    const ccCombined = ccDigits.map(d=>d.value.padEnd(4,' ').slice(0,4)).join('').slice(0,16).replace(/\s/g,'');
    safeSetText(form, "CC_Number", ccCombined);

    // UPDATED PDF-FILL LOGIC FOR CARD EXPIRY
    const mm = document.getElementById("CC_MM_Select").value;
    const yy = document.getElementById("CC_YY_Select").value;
    let expiry = "";
    if (mm && yy) {
      const monthNames = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];
      const monthIndex = parseInt(mm, 10) - 1;
      const fullYear = `20${yy}`;
      expiry = `${monthNames[monthIndex]} ${fullYear}`;
    }
    safeSetText(form, "CC_Expirydate", expiry);

    // Banks (checkboxes)
    const bankFields = ["CC_Bank_UOB","CC_Bank_CIMB","CC_Bank_HLB","CC_Bank_PBB","CC_Bank_MBB","CC_Bank_HSBC","CC_Bank_Alliance","CC_Bank_StanChart"];
    bankFields.forEach(b => safeCheck(form, b, false));
    const bankSel = $("CC_Bank_Select").value;
    if (bankSel) safeCheck(form, bankSel, true);

    // Card type
    safeCheck(form, "Visa", false); safeCheck(form, "Master", false);
    const cardType = $("CardType_Select").value; if (cardType) safeCheck(form, cardType, true);

    // EPP Term
    safeCheck(form, "EPPTerm_6Months", false); safeCheck(form, "EPPTerm_12Months", false);
    const term = $("EPPTerm_Select").value; if (term) safeCheck(form, term, true);

    // After EPP frequency
    const afterFields = ["AfterEPP_Annually","AfterEPP_Halfyearly","AfterEPP_Quarterly","AfterEPP_Monthly"];
    afterFields.forEach(a => safeCheck(form, a, false));
    const afterSel = $("AfterEPP_Select").value; if (afterSel) safeCheck(form, afterSel, true);

    // policies rows
    const rows = Array.from(policiesContainer.querySelectorAll(".policy"));
    rows.forEach((row, idx) => {
      const i = idx+1;
      const pNo = row.querySelector(`#Paymentfor_PolicyNo${i}`)?.value || row.querySelector(`[id^="Paymentfor_PolicyNo"]`)?.value || "";
      const owner = row.querySelector(`#Paymentfor_PolicyNo${i}_OwnerName`)?.value || "";
      const rel = row.querySelector(`#Paymentfor_PolicyNo${i}_Relationship`)?.value || "";
      const firstPrem = row.querySelector(`#Paymentfor_PolicyNo${i}_FirstPremium`)?.value || "";
      safeSetText(form, `Paymentfor_PolicyNo${i}`, pNo);
      safeSetText(form, `Paymentfor_PolicyNo${i}_OwnerName`, owner);
      safeSetText(form, `Paymentfor_PolicyNo${i}_Relationship`, rel);
      safeSetText(form, `Paymentfor_PolicyNo${i}_FirstPremium`, firstPrem);
    });
    for(let i = rows.length+1; i<=MAX_POLICIES; i++){
      safeSetText(form, `Paymentfor_PolicyNo${i}`, "");
      safeSetText(form, `Paymentfor_PolicyNo${i}_OwnerName`, "");
      safeSetText(form, `Paymentfor_PolicyNo${i}_Relationship`, "");
      safeSetText(form, `Paymentfor_PolicyNo${i}_FirstPremium`, "");
    }

    // Section 5
    safeSetText(form, "Signed_State", $("Signed_State").value || "");
    safeSetText(form, "Signed_Month", $("Signed_Month").value || "");
    safeSetText(form, "Signed_Day", $("Signed_Day").value || "");
    safeSetText(form, "Signed_Year", $("Signed_Year").value || "");
    safeSetText(form, "Witness_Name", $("Witness_Name").value || "");
    safeSetText(form, "Witness_NRIC", $("Witness_NRIC").value || "");

// Load saved coords or defaults
function getCoord(id, def){
  return parseFloat(localStorage.getItem(id) || document.getElementById(id).value || def);
}

document.getElementById("saveCoords").addEventListener("click", () => {
  ["cardholder_x","cardholder_y","cardholder_scale",
   "witness_x","witness_y","witness_scale"].forEach(id=>{
    localStorage.setItem(id, document.getElementById(id).value);
  });
  alert("Signature placement saved!");
});

// Signature embedding
const pages = pdfDoc.getPages();
const pageForSign = pages[Math.min(1, pages.length-1)];

const poSig = localStorage.getItem('cardholder_sig');
const wSig  = localStorage.getItem('witness_sig');

if (poSig) {
  const img = await pdfDoc.embedPng(poSig);
  const { width, height } = img.size();
  const scale = getCoord("cardholder_scale", 0.45);
  pageForSign.drawImage(img, {
    x: getCoord("cardholder_x", 360),
    y: getCoord("cardholder_y", 120),
    width: width * scale,
    height: height * scale
  });
}

if (wSig) {
  const img = await pdfDoc.embedPng(wSig);
  const { width, height } = img.size();
  const scale = getCoord("witness_scale", 0.45);
  pageForSign.drawImage(img, {
    x: getCoord("witness_x", 140),
    y: getCoord("witness_y", 120),
    width: width * scale,
    height: height * scale
  });
}
    // Save & download
    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "Filled_ZeroInterest_EPP.pdf"; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 2500);

  } catch (err) {
    console.error(err);
    alert("PDF generation failed: " + (err.message || err));
  } finally {
    $("generate").disabled = false;
  }
}

/* ---------- Reset All ---------- */
function resetAll(){
  document.querySelectorAll("input").forEach(inp=>{ if(inp.type==='checkbox' || inp.type==='radio') inp.checked=false; else inp.value=''; });
  document.querySelectorAll("select").forEach(s=> s.selectedIndex = 0);
  localStorage.clear();
  // remove policy nodes and recreate
  policiesContainer.innerHTML = ""; policyCount = 0; addPolicyBtn.disabled=false; addPolicy();
  // restore previews empty
  previews.cardholder.innerHTML = `<span>Tap to Sign (Cardholder)</span>`;
  previews.witness.innerHTML = `<span>Tap to Sign (Witness)</span>`;
}

/* ---------- Wire events ---------- */
$("generate").addEventListener("click", fillPDF);
$("resetAll").addEventListener("click", resetAll);

/* ---------- Restore saved form values on load ---------- */
(function restoreSavedValues(){
  document.querySelectorAll("input,select,textarea").forEach(el=>{
    const saved = localStorage.getItem(el.id);
    if(saved !== null) {
      if (el.type === 'checkbox') {
        el.checked = (saved === 'true');
      } else {
        el.value = saved;
      }
    }
  });
  // Restore dynamic policy entries
  let savedPolicyCount = parseInt(localStorage.getItem('policyCount')) || 1;
  policiesContainer.innerHTML = "";
  policyCount = 0;
  for(let i=1; i<=savedPolicyCount; i++){
      addPolicy();
  }
  
  restoreSignaturePreviews();
})();

/* ---------- Small nicety: show Save indicator when localStorage is updated by other code ---------- */
window.addEventListener('storage', ()=> showSaveStatus());

</script>
</body>
</html>
